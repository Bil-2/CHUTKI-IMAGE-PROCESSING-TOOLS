name: Keep Server Alive - Multi-Layer Protection

on:
  schedule:
    # Run every 5 minutes for maximum uptime
    - cron: "*/5 * * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Multi-Endpoint Keep-Alive Ping
        run: |
          echo "ğŸš€ CHUTKI Multi-Layer Keep-Alive System"
          echo "â° $(date)"
          echo "=" | tr '=' '=' | head -c 50; echo

          BACKEND_URL="https://chutki-image-processing-tools.onrender.com"

          # Function to ping endpoint
          ping_endpoint() {
            local endpoint=$1
            local name=$2
            
            echo "ğŸ”„ Pinging $name..."
            start_time=$(date +%s%3N)
            
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: GitHub-Actions-KeepAlive-v3" \
              -H "Accept: application/json" \
              -H "Cache-Control: no-cache" \
              --max-time 15 \
              "${BACKEND_URL}${endpoint}")
            
            end_time=$(date +%s%3N)
            duration=$((end_time - start_time))
            
            if [ "$response" = "200" ]; then
              echo "âœ… $name: HTTP $response (${duration}ms)"
              return 0
            else
              echo "âš ï¸ $name: HTTP $response (${duration}ms)"
              return 1
            fi
          }

          # Ping multiple endpoints for redundancy
          success_count=0
          total_count=0

          # Primary health check
          if ping_endpoint "/api/health" "Health Check"; then
            ((success_count++))
          fi
          ((total_count++))
          sleep 2

          # Tools health check
          if ping_endpoint "/api/tools/health" "Tools Health" 2>/dev/null || true; then
            ((success_count++))
          fi
          ((total_count++))
          sleep 2

          # Auth status check
          if ping_endpoint "/api/auth/status" "Auth Status" 2>/dev/null || true; then
            ((success_count++))
          fi
          ((total_count++))
          sleep 2

          # Warm-up critical endpoints (fire and forget)
          echo "ğŸ”¥ Warming up critical endpoints..."
          curl -s -o /dev/null \
            -H "User-Agent: GitHub-Actions-WarmUp" \
            --max-time 10 \
            "${BACKEND_URL}/api/tools/list" 2>/dev/null || true

          echo "=" | tr '=' '=' | head -c 50; echo
          echo "ğŸ“Š Results: $success_count/$total_count successful"

          if [ $success_count -gt 0 ]; then
            echo "âœ… Keep-alive completed successfully"
            exit 0
          else
            echo "âŒ All pings failed - server may be down"
            exit 1
          fi
